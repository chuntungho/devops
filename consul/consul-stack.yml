version: '3.6'

networks:
  app-net:
    external: true

volumes:
  consul-data:
  consul-client-data:

configs:
  git2consul-conf:
    file: ./git2consul.json

# https://stackoverflow.com/questions/54220374/consul-on-docker-swarm-with-spring-boot-clients
services:
  # ports: 8500
  consul-peer-a: &consul-peer
    image: "consul:1.11"
    networks:
      app-net:
        aliases:
          - consul-server
    environment:
      CONSUL_BIND_INTERFACE: eth0
      # https://www.consul.io/docs/agent/options
      CONSUL_LOCAL_CONFIG: '{"server": true,"bootstrap_expect": 3, "client_addr": "0.0.0.0", "disable_update_check": true}'
    command: [ "agent", "-node", "consul-peer-a", "-retry-join", "consul-peer-b", "-retry-join", "consul-peer-c" ]
    volumes:
      - consul-data:/consul/data
    deploy:
      placement:
        constraints:
          - "node.labels.consul-peer-name==consul-peer-a"

  consul-peer-b:
    <<: *consul-peer
    command: [ "agent", "-ui", "-node", "consul-peer-b", "-retry-join", "consul-peer-a","-retry-join", "consul-peer-c" ]
    deploy:
      placement:
        constraints:
          - "node.labels.consul-peer-name==consul-peer-b"

  consul-peer-c:
    <<: *consul-peer
    command: [ "agent", "-node", "consul-peer-c", "-retry-join", "consul-peer-a","-retry-join", "consul-peer-b" ]
    deploy:
      placement:
        constraints:
          - "node.labels.consul-peer-name==consul-peer-c"

  # Deploy consul client as sidecar in k8s, which is not supported in swarm.
  # To work around, deploy consul client on each swarm node, connect to consul client (172.17.0.1) inside a container.
  consul-client:
    image: "consul:1.11"
    networks:
      app-net:
    ports:
      - target: 8500
        published: 8500
        mode: host
    environment:
      CONSUL_BIND_INTERFACE: eth0
      CONSUL_LOCAL_CONFIG: '{"client_addr": "0.0.0.0", "disable_update_check": true}'
    command: [ "agent", "-ui", "-retry-join", "consul-server" ]
    volumes:
      - consul-client-data:/consul/data
    deploy:
      mode: global
      placement:
        constraints:
          - "node.labels.app-server==true"

  git2consul-go:
    image: chuntungho/git2consul-go
    networks:
      - app-net
    configs:
      - source: git2consul-conf
        target: /etc/git2consul.json
    command: ["-config", "/etc/git2consul.json", "-debug"]
    deploy:
      placement:
        constraints:
          - "node.role == manager"